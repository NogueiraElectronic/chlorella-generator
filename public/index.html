// Funci√≥n mejorada para crear gr√°fica de biomasa con mejor visualizaci√≥n
function createBiomassChart() {
    const ctx = document.getElementById('biomassChart').getContext('2d');
    if (charts.biomass) charts.biomass.destroy();
    
    // Filtrar solo escenarios con datos suficientes
    const scenarios = [...new Set(currentDataset.map(d => d.Scenario))].slice(0, 8);
    const colors = ['#28a745', '#17a2b8', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14', '#20c997', '#6c757d'];
    
    // Preparar datos por escenario con mejor procesamiento
    const datasets = scenarios.map((scenario, index) => {
        const scenarioData = currentDataset
            .filter(d => d.Scenario === scenario)
            .sort((a, b) => (a.Time_days || 0) - (b.Time_days || 0));
        
        // Procesar datos para mejor visualizaci√≥n
        const processedData = scenarioData.map(d => ({
            x: d.Time_days || 0,
            y: d.Biomass_g_L || 0
        }));
        
        // Filtrar datos extremos si es necesario
        const validData = processedData.filter(d => d.y > 0 && d.y < 10);
        
        return {
            label: `Escenario ${scenario}`,
            data: validData,
            borderColor: colors[index % colors.length],
            backgroundColor: colors[index % colors.length] + '20',
            tension: 0.4,
            pointRadius: 2,
            pointHoverRadius: 4,
            borderWidth: 3,
            fill: false
        };
    });
    
    // Calcular rangos para mejor escala
    const allYValues = datasets.flatMap(d => d.data.map(p => p.y));
    const minY = Math.min(...allYValues);
    const maxY = Math.max(...allYValues);
    const yPadding = (maxY - minY) * 0.1;
    
    charts.biomass = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { 
                    display: true, 
                    position: 'top',
                    labels: { usePointStyle: true }
                },
                title: { 
                    display: true, 
                    text: 'Curvas de Crecimiento Sigmoidal - Chlorella vulgaris',
                    font: { size: 16, weight: 'bold' }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y.toFixed(3)} g/L`;
                        }
                    }
                }
            },
            scales: {
                x: { 
                    title: { 
                        display: true, 
                        text: 'Tiempo (d√≠as)',
                        font: { size: 14, weight: 'bold' }
                    },
                    grid: { 
                        color: 'rgba(0,0,0,0.1)',
                        drawBorder: false
                    },
                    ticks: {
                        font: { size: 12 }
                    }
                },
                y: { 
                    title: { 
                        display: true, 
                        text: 'Biomasa (g/L)',
                        font: { size: 14, weight: 'bold' }
                    },
                    beginAtZero: false,
                    min: Math.max(0, minY - yPadding),
                    max: maxY + yPadding,
                    grid: { 
                        color: 'rgba(0,0,0,0.1)',
                        drawBorder: false
                    },
                    ticks: {
                        font: { size: 12 },
                        callback: function(value) {
                            return value.toFixed(2);
                        }
                    }
                }
            },
            interaction: {
                mode: 'index',
                intersect: false
            },
            animation: {
                duration: 1000,
                easing: 'easeOutQuart'
            }
        }
    });
    
    // Agregar informaci√≥n estad√≠stica
    const statsInfo = document.createElement('div');
    statsInfo.innerHTML = `
        <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px;">
            <strong>üìä Estad√≠sticas de Biomasa:</strong><br>
            Rango: ${minY.toFixed(3)} - ${maxY.toFixed(3)} g/L<br>
            Promedio: ${(allYValues.reduce((a, b) => a + b, 0) / allYValues.length).toFixed(3)} g/L<br>
            Escenarios visualizados: ${scenarios.length}
        </div>
    `;
    ctx.canvas.parentNode.appendChild(statsInfo);
}

// Funci√≥n auxiliar para an√°lisis de calidad de las curvas
function analyzeBiomassQuality() {
    const scenarios = [...new Set(currentDataset.map(d => d.Scenario))];
    const analysis = {};
    
    scenarios.forEach(scenario => {
        const data = currentDataset
            .filter(d => d.Scenario === scenario)
            .sort((a, b) => (a.Time_days || 0) - (b.Time_days || 0));
        
        const biomassValues = data.map(d => d.Biomass_g_L || 0);
        const timeValues = data.map(d => d.Time_days || 0);
        
        // An√°lisis de crecimiento
        const maxBiomass = Math.max(...biomassValues);
        const initialBiomass = biomassValues[0] || 0;
        const finalBiomass = biomassValues[biomassValues.length - 1] || 0;
        
        // Detectar fases de crecimiento
        const growthRate = (finalBiomass - initialBiomass) / (timeValues[timeValues.length - 1] - timeValues[0]);
        
        analysis[scenario] = {
            maxBiomass,
            initialBiomass,
            finalBiomass,
            growthRate,
            dataPoints: data.length,
            timeSpan: timeValues[timeValues.length - 1] - timeValues[0],
            avgBiomass: biomassValues.reduce((a, b) => a + b, 0) / biomassValues.length
        };
    });
    
    console.log('üìä An√°lisis de Calidad de Curvas:', analysis);
    return analysis;
}

// Funci√≥n para detectar si las curvas son realistas
function validateBiomassRealism() {
    const analysis = analyzeBiomassQuality();
    const validations = [];
    
    Object.entries(analysis).forEach(([scenario, data]) => {
        const checks = {
            scenario: parseInt(scenario),
            maxBiomassRealistic: data.maxBiomass >= 0.05 && data.maxBiomass <= 5.0,
            growthRateRealistic: data.growthRate >= 0 && data.growthRate <= 0.5,
            dataPointsSufficient: data.dataPoints >= 50,
            timeSpanAdequate: data.timeSpan >= 7,
            sigmoidalShape: data.maxBiomass > data.initialBiomass && data.maxBiomass > data.finalBiomass * 0.8
        };
        
        checks.overallValid = Object.values(checks).slice(1).every(Boolean);
        validations.push(checks);
    });
    
    return validations;
}

// Ejecutar al cargar las gr√°ficas
function improvedChartGeneration() {
    if (!currentDataset || currentDataset.length === 0) return;
    
    console.log('üî¨ Generando curvas mejoradas de biomasa...');
    
    // Validar realismo
    const validations = validateBiomassRealism();
    const validScenarios = validations.filter(v => v.overallValid).length;
    
    console.log(`‚úÖ Escenarios v√°lidos: ${validScenarios}/${validations.length}`);
    
    // Crear gr√°fica mejorada
    createBiomassChart();
    
    // Mostrar an√°lisis
    const analysisDiv = document.createElement('div');
    analysisDiv.innerHTML = `
        <div style="margin-top: 15px; padding: 15px; background: #e8f5e8; border-radius: 8px;">
            <h4>üî¨ Validaci√≥n Cient√≠fica de Curvas:</h4>
            <ul>
                <li><strong>Escenarios v√°lidos:</strong> ${validScenarios}/${validations.length}</li>
                <li><strong>Forma sigmoidal:</strong> ${validations.filter(v => v.sigmoidalShape).length} escenarios</li>
                <li><strong>Rango realista:</strong> ${validations.filter(v => v.maxBiomassRealistic).length} escenarios</li>
                <li><strong>Datos suficientes:</strong> ${validations.filter(v => v.dataPointsSufficient).length} escenarios</li>
            </ul>
        </div>
    `;
    
    document.getElementById('biomassChart').parentNode.appendChild(analysisDiv);
}
